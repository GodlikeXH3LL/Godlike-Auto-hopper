local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

local placeId = game.PlaceId
local Camera = workspace.CurrentCamera

local excludedNames = {
    ["TopKillsBrr"] = true,
}

local random = Random.new()
local function randomWait(min, max)
    task.wait(min + random:NextNumber() * (max - min))
end

local function obfuscatedHttpGet(url)
    randomWait(0.5, 1.5)
    local success, result = pcall(function()
        return game:HttpGet(url, true)
    end)
    if not success then
        randomWait(2, 4)
        return game:HttpGet(url, true)
    end
    return result
end

local function find18Or19PlayerServer()
    local cursor = ""
    repeat
        local url = ("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Desc&limit=100"):format(placeId)
        if cursor ~= "" then
            url = url .. "&cursor=" .. cursor
        end
        
        local responseStr = obfuscatedHttpGet(url)
        local success, response = pcall(function()
            return HttpService:JSONDecode(responseStr)
        end)
        
        if not success or not response or not response.data then
            randomWait(1, 3)
            continue
        end

        local servers = {}
        for _, server in ipairs(response.data) do
            if server.maxPlayers == 20 and server.id ~= game.JobId and (server.playing == 18 or server.playing == 19) then
                table.insert(servers, server.id)
            end
        end
        
        if #servers > 0 then
            return servers[random:NextInteger(1, #servers)]
        end

        cursor = response.nextPageCursor or ""
        randomWait(0.8, 2.2)
    until cursor == ""

    return nil
end

local function hopToServer()
    local serverId = find18Or19PlayerServer()
    if serverId then
        randomWait(1, 3)
        TeleportService:TeleportToPlaceInstance(placeId, serverId, LocalPlayer)
    else
        warn("No suitable server found. Retrying in 8-15 seconds...")
        task.delay(8 + random:NextNumber() * 7, hopToServer)
    end
end

local function setupCharacter(character)
    local humanoid = character:WaitForChild("Humanoid", 10)
    if not humanoid then return end
    
    humanoid.Died:Connect(function()
        randomWait(0.5, 1.5)
        hopToServer()
    end)

    task.spawn(function()
        while humanoid and humanoid.Parent do
            if humanoid.Health < humanoid.MaxHealth then
                humanoid.Health = humanoid.MaxHealth
            end
            randomWait(0.25, 0.45)
        end
    end)

    local backpack = LocalPlayer:WaitForChild("Backpack")
    local tool = backpack:FindFirstChild("Punch")
    if tool and humanoid then
        humanoid:EquipTool(tool)
        task.spawn(function()
            while tool and tool.Parent do
                if tool.Parent == character then
                    tool:Activate()
                elseif tool.Parent == backpack then
                    humanoid:EquipTool(tool)
                end
                randomWait(0.04, 0.07)
            end
        end)
    end
end

if LocalPlayer.Character then
    setupCharacter(LocalPlayer.Character)
end
LocalPlayer.CharacterAdded:Connect(setupCharacter)

task.delay(48, hopToServer)

task.spawn(function()
    while true do
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and excludedNames[player.DisplayName] then
                randomWait(0.3, 1)
                hopToServer()
                return
            end
        end
        randomWait(1.8, 2.6)
    end
end)

task.spawn(function()
    while true do
        local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root then
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local targetRoot = player.Character.HumanoidRootPart
                    root.CFrame = targetRoot.CFrame * CFrame.new(random:NextNumber(-2, 2), 0, random:NextNumber(-3, -1))
                end
            end
        end
        randomWait(0.08, 0.15)
    end
end)

local function disableEffects()
    for _, v in pairs(game:GetDescendants()) do
        if v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Smoke") or v:IsA("Fire") or v:IsA("Sparkles") then
            v.Enabled = false
        end
    end
    
    local Lighting = game:GetService("Lighting")
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 9e9
    Lighting.Brightness = 0
    Lighting.ClockTime = 0

    for _, v in pairs(Lighting:GetChildren()) do
        if v:IsA("PostEffect") then
            v.Enabled = false
        end
    end

    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01

    for _, v in pairs(game:GetDescendants()) do
        if v:IsA("Decal") or v:IsA("Texture") then
            v.Transparency = 1
        elseif v:IsA("BasePart") and not v:IsA("MeshPart") then
            v.Material = Enum.Material.SmoothPlastic
            local model = v:FindFirstAncestorWhichIsA("Model")
            local hasHumanoid = model and model:FindFirstChildOfClass("Humanoid")
            if not hasHumanoid then
                v.Reflectance = 0
            end
        end
    end
end

task.spawn(function()
    randomWait(2, 5)
    disableEffects()
    game.DescendantAdded:Connect(function(v)
        task.spawn(function()
            randomWait(0.1, 0.4)
            if v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Smoke") or v:IsA("Fire") or v:IsA("Sparkles") then
                v.Enabled = false
            end
        end)
    end)
end)

local espFolder = Instance.new("Folder")
espFolder.Name = "ESP"
espFolder.Parent = CoreGui

local espPlayers = {}
local updateESPConnection

local greenColor = Color3.fromRGB(0, 255, 0)
local orangeColor = Color3.fromRGB(255, 165, 0)
local redColor = Color3.fromRGB(255, 0, 0)

local function updateAllESP()
    local now = tick()
    local camPos = Camera.CFrame.Position
    for player, data in pairs(espPlayers) do
        local highlight = data.highlight
        if not highlight or not highlight.Parent then
            espPlayers[player] = nil
            continue
        end
        local char = highlight.Adornee
        if not char or not char.Parent then
            espPlayers[player] = nil
            continue
        end
        local root = char:FindFirstChild("HumanoidRootPart")
        if not root then
            continue
        end
        local dist = (camPos - root.Position).Magnitude
        local enabled = dist < 1000
        highlight.Enabled = enabled
        data.billboard.Enabled = enabled
        if now - data.lastUpdate > 0.1 then
            data.lastUpdate = now
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then
                local health = math.floor(hum.Health + 0.5)
                local maxHealth = hum.MaxHealth
                data.healthLabel.Text = health .. "/" .. maxHealth
                local percent = health / maxHealth
                local healthColor = percent > 0.5 and greenColor or (percent > 0.25 and orangeColor or redColor)
                data.healthLabel.TextColor3 = healthColor
                highlight.FillColor = healthColor
            end
        end
    end
end

task.spawn(function()
    updateESPConnection = RunService.Heartbeat:Connect(updateAllESP)
end)

local function addESP(player)
    if player == LocalPlayer then return end
    
    local function onCharacter(char)
        if not char then return end
        
        local highlight = Instance.new("Highlight")
        highlight.Name = "PlayerESP"
        highlight.Adornee = char
        highlight.FillColor = redColor
        highlight.FillTransparency = 0.7
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.OutlineTransparency = 0
        highlight.Parent = espFolder
        
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "NameESP"
        billboard.Adornee = char:WaitForChild("Head", 10)
        billboard.AlwaysOnTop = true
        billboard.Size = UDim2.new(0, 120, 0, 40)
        billboard.StudsOffset = Vector3.new(0, 3, 0)
        billboard.Parent = espFolder
        
        local nameLabel = Instance.new("TextLabel")
        nameLabel.BackgroundTransparency = 1
        nameLabel.Size = UDim2.new(1, 0, 0.6, 0)
        nameLabel.Text = player.DisplayName
        nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        nameLabel.TextSize = 12
        nameLabel.Font = Enum.Font.SourceSansBold
        nameLabel.TextStrokeTransparency = 0
        nameLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
        nameLabel.Parent = billboard
        
        local healthLabel = Instance.new("TextLabel")
        healthLabel.BackgroundTransparency = 1
        healthLabel.Position = UDim2.new(0, 0, 0.6, 0)
        healthLabel.Size = UDim2.new(1, 0, 0.4, 0)
        healthLabel.TextColor3 = greenColor
        healthLabel.TextSize = 12
        healthLabel.Font = Enum.Font.SourceSans
        healthLabel.TextStrokeTransparency = 0
        healthLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
        healthLabel.Parent = billboard
        
        espPlayers[player] = {
            highlight = highlight,
            billboard = billboard,
            healthLabel = healthLabel,
            lastUpdate = 0
        }
    end
    
    local function cleanup()
        local data = espPlayers[player]
        if data then
            data.highlight:Destroy()
            data.billboard:Destroy()
            espPlayers[player] = nil
        end
    end
    
    player.CharacterRemoving:Connect(cleanup)
    
    if player.Character then
        onCharacter(player.Character)
    end
    player.CharacterAdded:Connect(onCharacter)
end

for _, player in ipairs(Players:GetPlayers()) do
    task.spawn(function()
        randomWait(0.2, 0.8)
        addESP(player)
    end)
end

Players.PlayerAdded:Connect(function(player)
    task.spawn(function()
        randomWait(0.5, 1.5)
        addESP(player)
    end)
end)

Players.PlayerRemoving:Connect(function(player)
    local data = espPlayers[player]
    if data then
        data.highlight:Destroy()
        data.billboard:Destroy()
        espPlayers[player] = nil
    end
end)

syn and crypt and hash and getrenv and setrenv and getgc and debug = nil, nil, nil, nil, nil, nil, nil
getgenv().killAll = nil
